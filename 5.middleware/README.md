# Концепция middleware

## Что такое middleware

В любом веб-приложении может потребоваться внедрение дополнительных проверок или дополнительных возможностей на разных этапах обработки запроса. Например, проверить аутентификацию пользователя до начала обработки запроса или добавить в ответ служебные / информационные заголовки (тип ответа, размер содержимого, версия API и т.д.).

Если это необходимо повторять для нескольких view, то можно реализовать для этого отдельную функцию и добавлять её логику к view-функции при помощи декораторов.

Если же вам нужно внедрить логику на большинство или все view в приложении / проекте, можно использовать middleware (промежуточное ПО). С использованием такого подхода, вы можете попасть в середину любого запроса и изменить его до того, как он будет обработан внутри вашей функции-представления, а также сразу после этой функции, но перед отправкой окончательного ответа серверу. Middleware в Django могут использоваться для перехвата и обработки исключений. Они также позволяют вмешиваться в процесс формирования ответа, но это не обязательно связано с использованием шаблонов. Вмешательство может происходить на любом этапе обработки запроса или ответа, в зависимости от задач middleware.

> Основная задача middleware в том, чтобы выполнять одно и то же действие для всех запросов.

Например, авторизация в Django и проверка CSRF Token при выполнении небезопасных запросов осуществляется с помощью встроенных middleware-компонентов. Вы можете написать свой логгер, который будет подсчитывать время обработки каждого из запросов, а также собирать статистику по времени обработки. Для этого достаточно подключить middleware к проекту, это обеспечит доступ к каждому запросу, который получает приложение.

## Настройка middleware в проекте

В файле settings.py вы можете встретить переменную MIDDLEWARE. Обычно она выглядит так:
![Alt text](https://prof.learning.samolet.ru/data/scorms/ffcbb5b4-e2a0-48a5-bdd2-835ce674202b/res/data/islru-249352/66264dd5-9e34-11ee-a69d-7ae99d80b9e8.png)

По умолчанию в Django активны несколько middleware-компонентов, которые необходимы для его полноценной работы. Сюда относятся инструменты для обеспечения безопасности приложения, а также система аутентификации и авторизации. Подробнее middleware-компоненты, доступные в стандартной поставке, мы рассмотрим далее в этом уроке.

## Порядок выполнения middleware-компонентов
При обработке запроса Django по очереди выполняет все middleware-компоненты один за другим. Важно учитывать порядок их выполнения, так как это влияет на то, какие данные будут получены и будут ли учтены внесенные изменения.
Этапы обработки можно разделить на две части: предобработка запроса и постобработка ответа.
- Предобработка запроса
При получении входящего запроса Django вызывает по очереди все middleware-компоненты из списка, передавая туда входящий запрос. Порядок следования middleware-компонентов соответствует их размещению в списке. Каждый экземпляр middleware получает входящий запрос и при необходимости модифицирует его перед передачей во view-функцию. Это и есть объект request, который используется во view.

- Постобработка ответа

После того как view-функция сформировала и возвращает ответ, он проходит через все middleware-компоненты, но уже в обратном порядке (т.е. начиная с последнего в списке и заканчивая первым). Это позволяет провести дополнительную обработку или модификацию ответа перед его окончательной отправкой клиенту.
Формат такого обхода можно сравнить с матрешкой, где каждый слой middleware оборачивает центральную обработку запроса. Это похоже на то, как каждая матрешка помещается внутрь большей по размеру.

Для примера представьте сценарий, где запрос проходит через три middleware-компонента:
- Middleware A начинает обработку, выполняя некоторую логику перед передачей запроса далее
- Middleware B получает запрос от A, выполняет свои действия, а затем передаёт его в Middleware C.
- Middleware C является последним уровнем перед тем, как запрос достигает view-функции. 
- После C, запрос попадает во view.

![Alt text](https://prof.learning.samolet.ru/data/scorms/ffcbb5b4-e2a0-48a5-bdd2-835ce674202b/res/data/islru-249352/7d3d3838-9e34-11ee-a6e8-fab1bec65fa7.png)

Когда запрос достигает view-функции, она выполняет свою работу, а затем ответ начинает двигаться обратно. Он проходит сначала через C, затем B, и, наконец, A, прежде чем будет отправлен пользователю. Таким образом, каждый слой middleware добавляет свою логику как до, так и после основной обработки запроса, образуя структуру, напоминающую вложенные матрешки. Таким же образом работают вложенные декораторы: верхняя функция первой принимает параметры и последней отдаёт ответ.

> Поэтому важно учитывать порядок выполнения middleware-компонентов, так как каждый из них может зависеть от результатов работы предыдущего или должен быть применен после определенного middleware-компонента.


## Встроенные middleware в Django

Перед тем как создавать свои middleware-компоненты, стоит ознакомиться с набором встроенных инструментов, чтобы не изобретать велосипед. 

Полный их список вы можете найти в соответствующем разделе документации Django (https://docs.djangoproject.com/en/4.2/ref/middleware/). 

В этом уроке мы рассмотрим только основные middleware-компоненты.
1. CommonMiddleware
`CommonMiddleware` в Django предоставляет ряд полезных функций, включая:
автоматическое переписывание путей запроса, добавление конечного слеша, добавление www в начале пути запроса;
ограничение доступа для определенных устройств (фильтрация по user-agent);
правила по перенаправлению пользователя (статус код перенаправления по умолчанию).

Настройка и использование

- Для использования и настройки `CommonMiddleware` в проекте Django

    - Убедитесь, что `CommonMiddleware` включен в ваш `settings.py`:

    ![Alt text](https://prof.learning.samolet.ru/data/scorms/ffcbb5b4-e2a0-48a5-bdd2-835ce674202b/res/data/islru-249352/0f476c8f-9e35-11ee-a69d-7ae99d80b9e8.png)

    - Настройте параметры `CommonMiddleware` в `settings.py`, такие, как `APPEND_SLASH`, `PREPEND_WWW`, и другие, в зависимости от требований вашего проекта.
    - Для настройки правил перенаправления пользователей используйте настройки `HTTP_STATUS_CODE_REDIRECT`, `USE_X_FORWARDED_HOST` и другие

    Подробную информацию о параметрах настройки и примеры использования `CommonMiddleware` можно найти в официальной документации Django.
2. GZipMiddleware

`GZipMiddleware` в Django предназначен для сжатия HTTP-ответов, что помогает уменьшить объем передаваемых данных и ускорить загрузку страниц (это особенно полезно для статических файлов и больших ответов). После настройки он автоматически сжимает ответы для клиентов, которые поддерживают сжатие GZip.

Настройка и использование

- Чтобы использовать `GZipMiddleware` в вашем проекте Django:
    - Добавьте `GZipMiddleware` в ваш `settings.py`:
    ![Alt text](https://prof.learning.samolet.ru/data/scorms/ffcbb5b4-e2a0-48a5-bdd2-835ce674202b/res/data/islru-249352/2190e9b7-9e35-11ee-a69d-7ae99d80b9e8.png)

    - Убедитесь, что ваш веб-сервер правильно настроен для обработки сжатого содержимого.
    Для дополнительной информации и настроек сжатия обратитесь к официальной документации Django.
3. MessageMiddleware

`MessageMiddleware` в Django используется для отображения сообщений пользователю, делая управление ими более простым, эффективным и динамичным.

Он добавляет функциональность для временного хранения сообщений, которые можно отобразить пользователю в следующем запросе. Например, вы можете использовать флеш-сообщения для вывода уведомлений об успешных операциях или об ошибках, которые произошли в предыдущих запросах.
`MessageMiddleware` осуществляет сохранение сообщений в куки или в сессии между запросами, и позволяет легко получить доступ к этим сообщениям в последующих запросах.

Настройка и использование

- Чтобы включить и использовать `MessageMiddleware` в вашем проекте Django:
    - Добавьте `MessageMiddleware` в ваш `settings.py`:
    ![Alt text](https://prof.learning.samolet.ru/data/scorms/ffcbb5b4-e2a0-48a5-bdd2-835ce674202b/res/data/islru-249352/34238204-9e35-11ee-a6e8-fab1bec65fa7.png)

    - Используйте Django messages framework в ваших view-функциях и шаблонах для отображения сообщений пользователям.
    - Настройте хранение сообщений, выбрав один из поддерживаемых бэкендов в `settings.py`.
    Для более подробной информации об использовании и настройке `MessageMiddleware`, обратитесь к официальной документации Django.

4. SecurityMiddleware

`SecurityMiddleware` помогает защитить ваше приложение от различных угроз безопасности и является важной частью любого Django-проекта. Он обеспечивает проверку источника переадресаций, происхождения запросов, предотвращение стороннего чтения и многое другое.
Он включает в себя несколько функций, включая защиту от различных атак, таких как CSRF (межсайтовая подделка запроса), кликджекинг и сниффинг. SecurityMiddleware также предоставляет функциональность для настройки заголовков безопасности, таких как заголовки Content-Security-Policy и Strict-Transport-Security. В целом, SecurityMiddleware играет важную роль в обеспечении безопасности веб-приложений, помогая предотвратить различные уязвимости и атаки.

Настройка и использование

- Чтобы включить и настроить `SecurityMiddleware` в вашем проекте Django:
    - Убедитесь, что `SecurityMiddleware` добавлен в ваш `settings.py`:
    ![Alt text](https://prof.learning.samolet.ru/data/scorms/ffcbb5b4-e2a0-48a5-bdd2-835ce674202b/res/data/islru-249352/503652f0-9e35-11ee-a69d-7ae99d80b9e8.png)

    - Настройте параметры безопасности в `settings.py`, такие как `SECURE_BROWSER_XSS_FILTER`, `SECURE_CONTENT_TYPE_NOSNIFF` и другие, для укрепления безопасности вашего приложения.
    Для более подробной информации о настройке и использовании `SecurityMiddleware` обратитесь к официальной документации Django.

5. SessionMiddleware

`SessionMiddleware` в Django обеспечивает поддержку сессий, позволяя хранить временные данные пользователя на стороне сервера.

Настройка и использование

- Чтобы активировать и настроить `SessionMiddleware` в вашем проекте Django:
    - Убедитесь, что `SessionMiddleware` добавлен в список `MIDDLEWARE` в вашем `settings.py`:
    ![Alt text](https://prof.learning.samolet.ru/data/scorms/ffcbb5b4-e2a0-48a5-bdd2-835ce674202b/res/data/islru-249352/60f76fa5-9e35-11ee-a6e8-fab1bec65fa7.png)
    - Выберите и настройте бэкенд для сессий в `settings.py` (например, использование базы данных или кэшированных сессий).
    - Используйте сессии в вашем приложении для хранения данных пользователя, таких как данные аутентификации, предпочтения и другие временные данные.
    Для дополнительной информации о настройке и использовании `SessionMiddleware` обратитесь к официальной документации Django.

6. AuthenticationMiddleware

`AuthenticationMiddleware` дает возможность легко управлять аутентификацией и авторизацией пользователей, обеспечивая безопасность и персонализацию пользовательского опыта.

Настройка и использование

- Для включения и настройки `AuthenticationMiddleware` в вашем проекте Django:

    - Добавьте `AuthenticationMiddleware` в список `MIDDLEWARE` в `settings.py`:

    ![Alt text](https://prof.learning.samolet.ru/data/scorms/ffcbb5b4-e2a0-48a5-bdd2-835ce674202b/res/data/islru-249352/806a50d1-9e35-11ee-a6e8-fab1bec65fa7.png)

    Для более детальной информации о настройке и использовании AuthenticationMiddleware, обратитесь к официальной документации Django.

7. CsrfViewMiddleware

`CsrfViewMiddleware` предоставляет механизм защиты веб-приложений на Django от CSRF-атак, обеспечивая безопасность форм и запросов в вашем приложении (защищает от нежелательных и потенциально вредоносных запросов).
Когда `CsrfViewMiddleware` включен, он генерирует и сохраняет уникальный токен CSRF для каждого пользователя. Этот токен затем включается в формы и запросы, отправляемые пользователем.
При получении запроса с сервера `CsrfViewMiddleware` проверяет, совпадает ли токен в запросе с токеном, сохраненным для пользователя. Если токены не совпадают, запрос считается подделанным и отвергается. Это предотвращает атаки CSRF.

Настройка и использование

- Для активации и настройки `CsrfViewMiddleware` в вашем проекте Django:

    - Убедитесь, что `CsrfViewMiddleware` добавлен в список `MIDDLEWARE` в `settings.py`:
    ![Alt text](https://prof.learning.samolet.ru/data/scorms/ffcbb5b4-e2a0-48a5-bdd2-835ce674202b/res/data/islru-249352/9293eac8-9e35-11ee-a69d-7ae99d80b9e8.png)
    - Используйте CSRF-токены в ваших формах HTML и шаблонах, чтобы обеспечить защиту от CSRF-атак.
    - Настройте поведение `CsrfViewMiddleware` при необходимости, например, определив дополнительные доверенные источники для CSRF.
    Для более детальной информации о настройке и использовании `CsrfViewMiddleware` обратитесь к официальной документации Django.

> После изучения основных стандартных middleware-компонентов в Django, вы можете найти более подробные примеры их применения в официальной документации Django. Эти примеры помогут вам лучше понять, как эффективно использовать каждый из middleware в реальных проектах, а также как адаптировать их для удовлетворения уникальных потребностей вашего приложения.

## Итоги

Middleware в Django играет ключевую роль в обработке запросов и ответов. Оно действует как промежуточный слой, который может перехватывать запросы перед тем, как они достигнут view-функций, и ответы перед тем, как они будут отправлены клиенту. Это позволяет разработчикам вносить изменения в запросы или ответы, добавлять дополнительную обработку или логику, например, для аутентификации, кэширования, сжатия данных и многих других задач. Эта функциональность делает middleware важным инструментом для управления потоком данных и логикой приложения.